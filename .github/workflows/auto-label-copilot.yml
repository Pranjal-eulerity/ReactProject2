name: Auto Label Copilot PRs

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  label:
    runs-on: ubuntu-latest

    steps:
      - name: Auto label PRs
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request;
            const issueNumber = pr.number;

            console.log("PR #", issueNumber);

            // --------------------------------------------------
            // 1. Always add "S - 1st review"
            // --------------------------------------------------
            const BASE_LABELS = ["S - 1st review"];

            // --------------------------------------------------
            // 2. Check if experimentHelper.js had net line reduction
            // --------------------------------------------------
            const files = await github.paginate(
              github.rest.pulls.listFiles,
              {
                owner,
                repo,
                pull_number: issueNumber,
                per_page: 100,
              }
            );

            let isExperimentCleanup = false;

            for (const file of files) {
              if (file.filename.endsWith("experimentHelper.js")) {
                console.log("Found experimentHelper.js");
                console.log("Additions:", file.additions, "Deletions:", file.deletions);

                if (file.deletions > file.additions) {
                  console.log("Net line reduction detected ");
                  isExperimentCleanup = true;
                } else {
                  console.log("No net reduction ");
                }
              }
            }

            const desiredLabels = [...BASE_LABELS];

            if (isExperimentCleanup) {
              desiredLabels.push("C - exp cleanup");
            }

            console.log("Desired labels:", desiredLabels);

            // --------------------------------------------------
            // 3. Read existing labels
            // --------------------------------------------------
            const { data: existingLabels } =
              await github.rest.issues.listLabelsOnIssue({
                owner,
                repo,
                issue_number: issueNumber,
              });

            const existingNames = existingLabels.map(l => l.name);

            const labelsToAdd = desiredLabels.filter(
              label => !existingNames.includes(label)
            );

            if (labelsToAdd.length === 0) {
              console.log("No new labels to add ðŸ’¤");
              return;
            }

            // --------------------------------------------------
            // 4. Apply labels
            // --------------------------------------------------
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: issueNumber,
              labels: labelsToAdd,
            });

            console.log(" Added labels:", labelsToAdd.join(", "));
